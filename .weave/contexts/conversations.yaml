context: conversations
description: "Threaded conversations across platforms with full message history"

domains:
  - messages
  - person
  - channels

sources:
  - database: insightmesh
    table: conversations
    joins:
      - table: messages
        on: "conversations.id = messages.conversation_id"
      - table: insightmesh_users
        on: "conversations.user_id = insightmesh_users.id"
  - database: slack
    table: slack_messages
    filters:
      thread_ts: "NOT NULL"
    group_by: "thread_ts"
  - elastic: conversation_index
    query_fields: [title, summary, tags]

tools:
  - slack
  - notion
  - webcat

permissions:
  default: read
  roles:
    - participant
    - observer
    - admin
  scopes:
    participant: "own_conversations"
    observer: "public_conversations"
    admin: "all_conversations"

aggregations:
  message_count: "COUNT(messages.id)"
  last_activity: "MAX(messages.created_at)"
  participants: "ARRAY_AGG(DISTINCT users.name)"

filters:
  active_only: "last_activity > NOW() - INTERVAL '30 days'"
  user_scope: "$user.id" 