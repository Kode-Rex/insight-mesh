{
    # Global options
    admin off
    auto_https off
    
    security {
        oauth identity provider google {
            realm google
            driver google
            client_id {$GOOGLE_CLIENT_ID}
            client_secret {$GOOGLE_CLIENT_SECRET}
            scopes openid email profile
        }

        authentication portal myportal {
            enable identity provider google
            cookie domain {$DOMAIN}
        }

        authorization policy mypolicy {
            set auth url /auth
            allow roles authp/user
            validate bearer header
            acl rule {
                comment "Allow users with gmail.com addresses"
                match email domain {$ALLOWED_EMAIL_DOMAIN}
                allow stop
            }
        }
    }
}

:80 {
    # Root path with authentication
    route /* {
        authorize with mypolicy
        reverse_proxy openwebui:3000
    }

    # Authentication portal
    route /auth* {
        authenticate with myportal
    }

    # Log requests
    log {
        output file /var/log/caddy/access.log
        format console
    }
}
